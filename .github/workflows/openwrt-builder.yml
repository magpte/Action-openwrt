#
# https://github.com/P3TERX/Actions-OpenWrt
#
# File: .github/workflows/openwrt-bulder.yml
# Description: Build OpenWrt using GitHub Actions
#
# Copyright (c) 2019-2024 P3TERX <https://p3terx.com>
#
# This is free software, licensed under the MIT License.
# See /LICENSE for more information.
#

name: OpenWrt Builder

on:
  repository_dispatch:
  workflow_dispatch:

env:
  REPO_URL: https://github.com/AgustinLorenzo/openwrt
  REPO_BRANCH: main_nss
  FEEDS_CONF: feeds.conf.default
  CONFIG_FILE: .config
  UPLOAD_BIN_DIR: true
  UPLOAD_FIRMWARE: true
  UPLOAD_RELEASE: true
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Initialization environment
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL
        sudo docker image prune --all --force
        sudo -E apt-get -qq update
        sudo -E apt-get -qq install build-essential clang flex bison g++ gawk gcc-multilib g++-multilib gettext git libncurses-dev libssl-dev python3-distutils python3-setuptools rsync swig unzip zlib1g-dev file wget
        sudo -E apt-get -qq autoremove --purge
        sudo -E apt-get -qq clean
        sudo timedatectl set-timezone "$TZ"
        sudo mkdir -p /workdir
        sudo chown $USER:$GROUPS /workdir

    - name: Clone source code
      working-directory: /workdir
      run: |
        df -hT $PWD
        git clone $REPO_URL -b $REPO_BRANCH openwrt
        ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt

    - name: Load custom feeds
      run: |
        [ -e $FEEDS_CONF ] && mv $FEEDS_CONF openwrt/feeds.conf.default
        chmod +x $DIY_P1_SH
        cd openwrt
        $GITHUB_WORKSPACE/$DIY_P1_SH

    - name: Update feeds
      run: cd openwrt && ./scripts/feeds update -a

    - name: Install feeds
      run: cd openwrt && ./scripts/feeds install -a

    - name: Load custom configuration
      run: |
        [ -e files ] && mv files openwrt/files
        [ -e $CONFIG_FILE ] && mv $CONFIG_FILE openwrt/.config
        chmod +x $DIY_P2_SH
        cd openwrt
        $GITHUB_WORKSPACE/$DIY_P2_SH

    - name: QoL fixes on default config
      run: |
        mkdir -p files/etc/uci-defaults
        cat > files/etc/uci-defaults/99-qol_fixes << EOF
        uci set wireless.radio0.country='US'
        uci set wireless.radio1.country='US'
        uci set wireless.radio2.country='US'
        uci set wireless.radio1.disabled=0
        uci set wireless.radio2.disabled=0
        uci set pbuf.opt.memory_profile=auto
        uci set network.globals.packet_steering=0
        uci set firewall.@defaults[0].flow_offloading=0
        uci set ecm.@general[0].enable_bridge_filtering=0
        uci commit
        EOF

    - name: Download package sources
      run: make download V=s

    - name: Build tools
      run: |
        make tools/install -j$(nproc) V=s || \
                make tools/install V=s

    - name: Build toolchain
      run: |
        make toolchain/install -j$(nproc) V=s || \
        make toolchain/install V=s

    - name: Build target images
      run: |
        make -j$(nproc) V=s || \
        make V=s

    - name: Get the current date
      run: echo "NOW=$(date +%F-%H%M)" >> $GITHUB_ENV

    - name: Create a release
      uses: "ncipollo/release-action@v1"
      with:
        name: "Updated prebuilt images (NSS-WiFi) ${{ env.NOW }}"
        commit: "main_nss"
        tag: "ipq807x-nsswifi-${{ env.NOW }}"
        enerateReleaseNotes: true
        makeLatest: true
        artifacts: bin/targets/qualcommax/ipq807x/*
        token: "${{ secrets.GITHUB_TOKEN }}"
